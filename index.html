<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>业余无线电A类考证刷题系统</title>
    <!-- 引入独立的题库文件 -->
    <script src="questions.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4299e1;
            --primary-light: #e8f4f8;
            --secondary-color: #38b2ac;
            --danger-color: #e53e3e;
            --danger-light: #fef2f2;
            --success-color: #48bb78;
            --success-light: #f0fdf4;
            --dark-color: #2d3748;
            --light-color: #f7fafc;
            --gray-color: #cbd5e0;
            --gray-dark: #718096;
            --text-color: #4a5568;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            background-color: #f5f5f5;
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px 30px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        header h1 {
            font-size: 28px;
            color: var(--dark-color);
            margin-bottom: 8px;
        }

        header p {
            font-size: 16px;
            color: var(--gray-dark);
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .stat-item {
            text-align: center;
        }

        .stat-item .value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-item .label {
            font-size: 14px;
            color: var(--text-color);
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .question-area {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            background-color: var(--light-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            max-width: 200px;
        }

        .mode-btn:hover {
            background-color: var(--gray-color);
        }

        .mode-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }
        
        .mode-btn.error-mode {
            background-color: var(--danger-color);
        }
        .mode-btn.error-mode.active {
             box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }

        .progress-container {
            width: 100%;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-header #progressText {
            font-weight: 600;
            color: var(--text-color);
        }

        .progress-header #currentModeDisplay {
            font-size: 14px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .progress-bar {
            height: 10px;
            background-color: var(--light-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 5px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .question-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--light-color);
        }

        .question-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--dark-color);
            font-weight: 600;
            line-height: 1.5;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border: 2px solid var(--light-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-item:hover {
            background-color: var(--light-color);
            border-color: var(--gray-color);
        }

        .option-item.active {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .option-item input {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }

        .option-item label {
            flex: 1;
            font-size: 16px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .option-item.active label {
            color: var(--primary-color);
            font-weight: 500;
        }

        .feedback {
            margin-bottom: 25px;
            padding: 18px;
            border-radius: 8px;
            display: none;
            border-left: 4px solid;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feedback.correct {
            background-color: var(--success-light);
            color: #047857;
            border-left-color: var(--success-color);
        }

        .feedback.incorrect {
            background-color: var(--danger-light);
            color: #c53030;
            border-left-color: var(--danger-color);
        }

        .feedback strong {
            display: block;
            margin-bottom: 5px;
            font-size: 17px;
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .operate-btn {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .prev-btn {
            background-color: var(--light-color);
            color: var(--text-color);
        }

        .prev-btn:hover {
            background-color: var(--gray-color);
        }

        .submit-next-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .submit-next-btn:hover {
            background-color: #319795;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 178, 172, 0.3);
        }

        .submit-next-btn.next-mode {
            background-color: var(--primary-color);
        }

        .submit-next-btn.next-mode:hover {
            background-color: #3182ce;
        }

        .submit-next-btn.finish-mode {
            background-color: var(--success-color);
        }

        .operate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .empty-state {
            text-align: center;
            padding: 50px 30px;
            color: var(--text-color);
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 20px;
            color: var(--gray-color);
        }

        .empty-state h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 16px;
            max-width: 500px;
            margin: 0 auto;
            color: var(--gray-dark);
        }

        .error-book-area {
            flex: 0 0 350px;
            min-width: 300px;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .error-book-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-color);
        }

        .error-book-header h2 {
            font-size: 20px;
            color: var(--danger-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .error-book-header h2 i {
            font-size: 24px;
        }

        .error-count-badge {
            background-color: var(--danger-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .error-book-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-color);
        }

        .error-list-container {
            flex: 1;
            overflow-y: auto;
            max-height: 60vh;
        }

        .error-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .error-item {
            background-color: var(--danger-light);
            border: 1px solid #fcc1c1;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .error-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(229, 62, 62, 0.1);
            border-color: var(--danger-color);
        }
        
        .error-item.selected {
            border-color: var(--danger-color);
            background-color: #ffe5e5;
        }

        .error-item .error-id {
            font-size: 14px;
            font-weight: bold;
            color: var(--danger-color);
        }

        .error-item .error-question {
            font-size: 14px;
            color: var(--text-color);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .error-item .error-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }
        .error-item .error-actions button {
            background: none;
            border: none;
            color: var(--gray-dark);
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .error-item .error-actions button:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .error-item .error-actions .delete-btn:hover {
            color: var(--danger-color);
        }

        .error-list-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-dark);
            font-size: 16px;
        }
        .error-list-empty i {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
            color: var(--gray-color);
        }

        footer {
            text-align: center;
            padding: 15px;
            font-size: 14px;
            color: var(--gray-dark);
        }

        .keyboard-hint {
            font-size: 12px;
            color: var(--gray-dark);
            margin-top: 5px;
            text-align: right;
        }

        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            .error-book-area {
                flex: 1;
                max-height: 500px;
            }
            .error-book-toggle {
                display: block;
            }
            .error-book-content {
                display: none;
            }
            .error-book-content.show {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>业余无线电A类考证刷题系统</h1>
            <p>智能练习，错题重做，助你一次通过</p>
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="value" id="completedCount">0</div>
                <div class="label">已做题数</div>
            </div>
            <div class="stat-item">
                <div class="value" id="errorCount">0</div>
                <div class="label">当前错题</div>
            </div>
            <div class="stat-item">
                <div class="value" id="totalQuestionCount">0</div>
                <div class="label">题库总数</div>
            </div>
        </div>

        <div class="main-content">
            <div class="question-area">
                <div class="mode-selector">
                    <button class="mode-btn" data-mode="random">
                        <i class="fas fa-random"></i> 随机模式
                    </button>
                    <button class="mode-btn" data-mode="sequence">
                        <i class="fas fa-list-ol"></i> 顺序模式
                    </button>
                    <button class="mode-btn" data-mode="simulation">
                        <i class="fas fa-clipboard-check"></i> 模拟测试
                    </button>
                    <button class="mode-btn error-mode" data-mode="error">
                        <i class="fas fa-exclamation-triangle"></i> 错题重做
                    </button>
                </div>

                <div class="progress-container">
                    <div class="progress-header">
                        <span id="progressText">进度: 0%</span>
                        <span id="currentModeDisplay">模式: 未选择</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div id="emptyState" class="empty-state">
                    <i class="fas fa-book-open"></i>
                    <h3>请选择刷题模式开始练习</h3>
                    <p>选择一个模式开始你的业余无线电A类考证练习之旅，祝你考试顺利！</p>
                </div>

                <div id="questionContainer" style="display: none; flex-grow: 1;">
                    <div class="question-card">
                        <div class="question-title" id="question"></div>
                        <div class="options" id="options"></div>
                        <div class="feedback" id="feedback"></div>
                        <div class="keyboard-hint">
                            <i class="fas fa-keyboard"></i> 键盘快捷键：1(A)/2(B)/3(C)/4(D) 选择选项，Enter 提交/下一题
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="operate-btn prev-btn" id="prevBtn" disabled>
                            <i class="fas fa-arrow-left"></i> 上一题
                        </button>
                        <button class="operate-btn submit-next-btn" id="submitNextBtn" disabled>
                            <i class="fas fa-check"></i> 提交答案
                        </button>
                    </div>
                </div>
            </div>

            <div class="error-book-area">
                <div class="error-book-header">
                    <h2><i class="fas fa-exclamation-circle"></i> 错题本</h2>
                    <div class="error-book-controls">
                        <span class="error-count-badge" id="errorCountBadge">0</span>
                        <button class="error-book-toggle" id="errorBookToggle">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                <div class="error-book-content" id="errorBookContent">
                    <div class="error-list-container">
                        <ul class="error-list" id="errorList">
                            <li class="error-list-empty" id="errorListEmpty">
                                <i class="far fa-smile-beam"></i>
                                <p>暂无错题，继续保持！</p>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>© 2025 业余无线电A类考证刷题系统 | 题库已缓存至本地，支持离线使用</p>
        </footer>
    </div>

    <script>
        let questions = [];
        let currentMode = "";
        let currentQuestionIndex = 0;
        let selectedOptions = [];
        let completedQuestions = [];
        let errorQuestions = [];
        let simulationQuestions = [];
        let simulationAnswered = 0;
        let currentErrorId = null;
        let isSubmitted = false;

        window.onload = function() {
            if (window.allQuestions && window.allQuestions.length > 0) {
                questions = JSON.parse(JSON.stringify(window.allQuestions));
            } else {
                alert("题库加载失败，请确保 questions.js 文件已正确引入。");
                return;
            }

            initLocalStorage();
            loadProgress();
            bindEvents();
            updateStats();
            renderErrorBook();
            document.getElementById('totalQuestionCount').textContent = questions.length;

            if (currentMode) {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('questionContainer').style.display = 'flex';
                if (currentMode === 'error' && errorQuestions.length > 0) {
                    loadErrorQuestionIntoView(errorQuestions[0]);
                } else if (currentMode === 'simulation') {
                    initSimulation();
                } else {
                    showQuestion(currentQuestionIndex);
                }
            }
        };

        function initLocalStorage() {
            const storedQuestions = localStorage.getItem('radioExamQuestions');
            if (!storedQuestions || JSON.parse(storedQuestions).length < questions.length) {
                localStorage.setItem('radioExamQuestions', JSON.stringify(questions));
                console.log('题库已初始化/更新到本地存储');
            } else {
                questions = JSON.parse(storedQuestions);
                console.log('从本地存储加载题库成功');
            }
        }

        function loadProgress() {
            const progress = localStorage.getItem('examProgress');
            if (progress) {
                const { mode, index, completed, errors, simulation, simAnswered } = JSON.parse(progress);
                currentMode = mode || "";
                currentQuestionIndex = index || 0;
                completedQuestions = completed ? [...new Set(completed)] : [];
                errorQuestions = Array.isArray(errors) ? [...new Set(errors)] : [];
                simulationQuestions = simulation || [];
                simulationAnswered = simAnswered || 0;
            }
            if (currentMode) {
                document.querySelector(`.mode-btn[data-mode="${currentMode}"]`).classList.add('active');
                document.getElementById('currentModeDisplay').textContent = `模式: ${getModeName(currentMode)}`;
            }
        }

        function saveProgress() {
            const progress = JSON.stringify({
                mode: currentMode,
                index: currentQuestionIndex,
                completed: completedQuestions,
                errors: errorQuestions,
                simulation: simulationQuestions,
                simAnswered: simulationAnswered
            });
            localStorage.setItem('examProgress', progress);
        }

        function updateStats() {
            document.getElementById('completedCount').textContent = completedQuestions.length;
            document.getElementById('errorCount').textContent = errorQuestions.length;
            document.getElementById('errorCountBadge').textContent = errorQuestions.length;
        }
        
        function updateProgressBar() {
            let progress = 0;
            let progressText = "进度: ";
            
            if (currentMode === "sequence") {
                progress = (completedQuestions.length / questions.length) * 100;
                progressText += `${completedQuestions.length}/${questions.length} (${Math.round(progress)}%)`;
            } else if (currentMode === "simulation" && simulationQuestions.length > 0) {
                progress = (simulationAnswered / simulationQuestions.length) * 100;
                progressText += `模拟测试: ${simulationAnswered}/${simulationQuestions.length} (${Math.round(progress)}%)`;
            } else if (currentMode === "random") {
                progress = (completedQuestions.length / questions.length) * 100;
                progressText += `已完成 ${completedQuestions.length}/${questions.length} (${Math.round(progress)}%)`;
            } else if (currentMode === "error" && errorQuestions.length > 0) {
                const errorIndex = errorQuestions.findIndex(id => id === currentErrorId);
                progress = ((errorIndex + 1) / errorQuestions.length) * 100;
                progressText += `错题重做: ${errorIndex + 1}/${errorQuestions.length} (${Math.round(progress)}%)`;
            }
            
            document.getElementById("progressText").textContent = progressText;
            document.getElementById("progressFill").style.width = `${progress}%`;
        }

        function getModeName(mode) {
            const modeMap = {
                random: "单题随机模式",
                sequence: "顺序循环模式",
                simulation: "30题模拟测试",
                error: "错题重做模式"
            };
            return modeMap[mode] || "未选择";
        }

        function renderErrorBook() {
            const errorListEl = document.getElementById('errorList');
            const errorListEmptyEl = document.getElementById('errorListEmpty');

            updateStats();

            if (errorQuestions.length === 0) {
                errorListEl.innerHTML = '';
                errorListEl.appendChild(errorListEmptyEl);
                errorListEmptyEl.style.display = 'block';
                return;
            }
            
            errorListEmptyEl.style.display = 'none';
            
            const errorQuestionObjs = errorQuestions.map(id => questions.find(q => q.id === id)).filter(q => q);
            
            errorListEl.innerHTML = errorQuestionObjs.map(question => `
                <li class="error-item ${currentErrorId === question.id ? 'selected' : ''}" data-id="${question.id}">
                    <div class="error-id">${question.id}</div>
                    <div class="error-question">${question.question}</div>
                    <div class="error-actions">
                        <button class="delete-btn" data-id="${question.id}"><i class="fas fa-trash-alt"></i> 删除</button>
                    </div>
                </li>
            `).join('');
        }
        
        function addToErrorBook(questionId) {
            if (!errorQuestions.includes(questionId)) {
                errorQuestions.push(questionId);
                saveProgress();
                renderErrorBook();
            }
        }
        
        function removeFromErrorBook(questionId) {
            const initialLength = errorQuestions.length;
            errorQuestions = errorQuestions.filter(id => id !== questionId);
            
            if (initialLength !== errorQuestions.length) {
                saveProgress();
                renderErrorBook();
                
                if (currentErrorId === questionId) {
                    currentErrorId = null;
                    if (currentMode === 'error' && errorQuestions.length === 0) {
                        switchMode('');
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('questionContainer').style.display = 'none';
                    } else if (currentMode === 'error' && errorQuestions.length > 0) {
                        loadErrorQuestionIntoView(errorQuestions[0]);
                    }
                }
            }
        }
        
        function loadErrorQuestionIntoView(questionId) {
            const questionIndex = questions.findIndex(q => q.id === questionId);
            if (questionIndex !== -1) {
                currentQuestionIndex = questionIndex;
                currentErrorId = questionId;
                showQuestion(currentQuestionIndex);
                
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('questionContainer').style.display = 'flex';
                
                document.querySelectorAll('.error-item').forEach(item => {
                    item.classList.toggle('selected', item.dataset.id === questionId);
                });
            }
        }
        
        function switchToErrorMode() {
            switchMode('error');
            if (errorQuestions.length > 0) {
                 loadErrorQuestionIntoView(errorQuestions[0]);
            } else {
                alert('当前没有错题可重做！');
            }
        }
        
        function switchMode(newMode) {
            currentMode = newMode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === currentMode);
            });
            document.getElementById('currentModeDisplay').textContent = currentMode ? `模式: ${getModeName(currentMode)}` : '模式: 未选择';

            isSubmitted = false;
            selectedOptions = [];
            simulationQuestions = [];
            simulationAnswered = 0;
            currentErrorId = null;

            const submitNextBtn = document.getElementById('submitNextBtn');
            submitNextBtn.disabled = true;
            submitNextBtn.innerHTML = '<i class="fas fa-check"></i> 提交答案';
            submitNextBtn.classList.remove('next-mode', 'finish-mode');

            saveProgress();
            updateProgressBar();
        }

        function showQuestion(index) {
            if (!currentMode) return;
            
            const questionEl = document.getElementById('question');
            const optionsEl = document.getElementById('options');
            const feedbackEl = document.getElementById('feedback');
            const submitNextBtn = document.getElementById('submitNextBtn');
            const prevBtn = document.getElementById('prevBtn');

            optionsEl.innerHTML = '';
            feedbackEl.style.display = 'none';
            selectedOptions = [];
            isSubmitted = false;

            const currentQ = questions[index];
            if (!currentQ) {
                questionEl.textContent = "题目加载失败";
                return;
            }

            questionEl.textContent = `${currentQ.id}：${currentQ.question}`;

            Object.entries(currentQ.options).forEach(([key, value], idx) => {
                const optionItem = document.createElement("div");
                optionItem.className = "option-item";
                optionItem.innerHTML = `
                    <input type="checkbox" id="opt-${key}" value="${key}" data-index="${idx + 1}">
                    <label for="opt-${key}"><span class="option-key">${key}.</span> ${value}</label>
                `;
                optionsEl.appendChild(optionItem);
            });

            document.querySelectorAll('.option-item input').forEach(input => {
                input.disabled = isSubmitted;
            });

            submitNextBtn.disabled = true;
            submitNextBtn.innerHTML = '<i class="fas fa-check"></i> 提交答案';
            submitNextBtn.classList.remove('next-mode', 'finish-mode');

            prevBtn.disabled = 
                (currentMode === "sequence" && index === 0) || 
                (currentMode === "simulation" && index === 0) ||
                (currentMode === "error" && errorQuestions.length <= 1) ||
                (currentMode === "random"); // 随机模式下，上一题按钮通常禁用

            updateProgressBar();
        }

        function getCurrentQuestion() {
            return questions[currentQuestionIndex];
        }
        
        // 核心修改点：更新随机题目索引获取逻辑
        function getRandomIndex() {
            // 筛选出所有未回答的题目ID
            const unansweredQuestionIds = questions
                .map(q => q.id)
                .filter(id => !completedQuestions.includes(id));

            // 检查是否所有题目都已完成
            if (unansweredQuestionIds.length === 0) {
                // 所有题目均已完成，刷新状态
                alert('恭喜！你已完成题库中所有题目，现在将重置进度，重新开始。');
                completedQuestions = []; // 清空已做题列表
                saveProgress(); // 保存重置后的状态
                updateStats();   // 更新UI统计
                updateProgressBar(); // 更新进度条
                // 返回一个全新的随机索引（从所有题目中）
                return Math.floor(Math.random() * questions.length);
            }
            
            // 从未做题中随机选择一个ID
            const randomId = unansweredQuestionIds[Math.floor(Math.random() * unansweredQuestionIds.length)];
            
            // 根据ID找到对应的索引并返回
            return questions.findIndex(q => q.id === randomId);
        }
        
        function initSimulation() {
            const shuffled = [...questions].sort(() => 0.5 - Math.random());
            simulationQuestions = shuffled.slice(0, 30);
            currentQuestionIndex = 0;
            simulationAnswered = 0;
            showQuestion(currentQuestionIndex);
        }
        
        function handleSubmit() {
            const currentQ = getCurrentQuestion();
            const isCorrect = checkAnswer(currentQ);
            const feedbackEl = document.getElementById('feedback');
            const submitNextBtn = document.getElementById('submitNextBtn');

            feedbackEl.style.display = 'block';
            if (isCorrect) {
                feedbackEl.className = 'feedback correct';
                feedbackEl.innerHTML = `<strong><i class="fas fa-check-circle"></i> 回答正确！</strong> 正确答案：${formatAnswer(currentQ.answer)}`;
                // 只有答对的题目才加入已做题列表
                if (!completedQuestions.includes(currentQ.id)) {
                    completedQuestions.push(currentQ.id);
                }
            } else {
                feedbackEl.className = 'feedback incorrect';
                feedbackEl.innerHTML = `<strong><i class="fas fa-times-circle"></i> 回答错误</strong> 正确答案：${formatAnswer(currentQ.answer)}`;
                if (!errorQuestions.includes(currentQ.id)) {
                    addToErrorBook(currentQ.id);
                }
            }

            isSubmitted = true;

            document.querySelectorAll('.option-item input').forEach(input => {
                input.disabled = true;
            });

            if (currentMode === "simulation") {
                simulationAnswered++;
                if (simulationAnswered === simulationQuestions.length) {
                    submitNextBtn.innerHTML = '<i class="fas fa-flag-checkered"></i> 完成测试';
                    submitNextBtn.classList.add('finish-mode');
                } else {
                    submitNextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> 下一题';
                    submitNextBtn.classList.add('next-mode');
                }
            } else {
                submitNextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> 下一题';
                submitNextBtn.classList.add('next-mode');
            }
            
            saveProgress();
            updateStats();
            updateProgressBar();
        }
        
        function handleNext() {
            if (currentMode === "simulation" && simulationAnswered === simulationQuestions.length) {
                const score = simulationQuestions.filter(q => completedQuestions.includes(q.id) && !errorQuestions.includes(q.id)).length;
                alert(`模拟测试完成！\n总分：${score}/${simulationQuestions.length}\n正确率：${Math.round((score/simulationQuestions.length)*100)}%`);
                switchMode('');
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('questionContainer').style.display = 'none';
                return;
            }

            if (currentMode === 'random') {
                currentQuestionIndex = getRandomIndex(); // 使用更新后的getRandomIndex
            } else if (currentMode === 'sequence') {
                // 顺序模式下，如果当前是最后一题，则提示完成
                if (currentQuestionIndex >= questions.length - 1) {
                     alert('恭喜！你已按顺序完成所有题目。');
                     // 可以选择在这里重置，或者让用户手动切换模式
                     // completedQuestions = []; 
                     // saveProgress();
                     switchMode('');
                     document.getElementById('emptyState').style.display = 'block';
                     document.getElementById('questionContainer').style.display = 'none';
                     return;
                }
                currentQuestionIndex = (currentQuestionIndex + 1) % questions.length;
            } else if (currentMode === 'simulation') {
                currentQuestionIndex = (currentQuestionIndex + 1) % simulationQuestions.length;
            } else if (currentMode === 'error') {
                const currentErrorIndex = errorQuestions.findIndex(id => id === currentErrorId);
                const newErrorIndex = (currentErrorIndex + 1) % errorQuestions.length;
                loadErrorQuestionIntoView(errorQuestions[newErrorIndex]);
                return;
            }
            
            showQuestion(currentQuestionIndex);
        }

        function checkAnswer(question) {
            const userAnswer = selectedOptions.sort().join("");
            const isCorrect = userAnswer === question.answer;

            if (currentMode === 'error' && isCorrect) {
                removeFromErrorBook(question.id);
            }
            // 注意：已做题的逻辑移至handleSubmit，确保只有答对才计入
            return isCorrect;
        }
        
        function formatAnswer(answerStr) {
            return answerStr.split('').join(', ');
        }

        function bindEvents() {
            document.querySelector('.mode-selector').addEventListener('click', function(e) {
                const modeBtn = e.target.closest('.mode-btn');
                if (!modeBtn) return;

                const mode = modeBtn.dataset.mode;
                if (mode === 'error') {
                    switchToErrorMode();
                } else {
                    switchMode(mode);
                    if (mode === 'simulation') {
                        initSimulation();
                    } else {
                        // 切换到随机模式时，立即获取一个未做过的题目
                        currentQuestionIndex = mode === 'random' ? getRandomIndex() : 0;
                        showQuestion(currentQuestionIndex);
                    }
                }
            });
            
            document.getElementById('errorBookToggle').addEventListener('click', function() {
                const contentEl = document.getElementById('errorBookContent');
                contentEl.classList.toggle('show');
                const iconEl = this.querySelector('i');
                iconEl.classList.toggle('fa-chevron-down', !contentEl.classList.contains('show'));
                iconEl.classList.toggle('fa-chevron-up', contentEl.classList.contains('show'));
            });

            document.getElementById('options').addEventListener('change', function(e) {
                if (e.target.type !== 'checkbox' || isSubmitted) return;

                const value = e.target.value;
                const optionItem = e.target.closest('.option-item');

                if (e.target.checked) {
                    selectedOptions.push(value);
                    optionItem.classList.add('active');
                } else {
                    selectedOptions = selectedOptions.filter(opt => opt !== value);
                    optionItem.classList.remove('active');
                }

                const currentQ = getCurrentQuestion();
                if (currentQ.type === '单选题' && e.target.type === 'checkbox') {
                    document.querySelectorAll('.option-item input').forEach(input => {
                        if (input.value !== value) {
                            input.checked = false;
                            input.closest('.option-item').classList.remove('active');
                        }
                    });
                    selectedOptions = [value];
                }

                document.getElementById('submitNextBtn').disabled = selectedOptions.length === 0;
            });

            document.getElementById('submitNextBtn').addEventListener('click', function() {
                if (isSubmitted) {
                    handleNext();
                } else {
                    handleSubmit();
                }
            });

            document.getElementById('prevBtn').addEventListener('click', function() {
                // 随机模式下通常不需要上一题功能，如果需要，可以自行实现
                if (currentMode === 'sequence') {
                    currentQuestionIndex = (currentQuestionIndex - 1 + questions.length) % questions.length;
                } else if (currentMode === 'simulation') {
                    currentQuestionIndex = (currentQuestionIndex - 1 + simulationQuestions.length) % simulationQuestions.length;
                } else if (currentMode === 'error') {
                    const currentErrorIndex = errorQuestions.findIndex(id => id === currentErrorId);
                    const newErrorIndex = (currentErrorIndex - 1 + errorQuestions.length) % errorQuestions.length;
                    loadErrorQuestionIntoView(errorQuestions[newErrorIndex]);
                    return;
                }
                
                showQuestion(currentQuestionIndex);
                saveProgress();
            });
            
            document.getElementById('errorList').addEventListener('click', function(e) {
                const errorItemEl = e.target.closest('.error-item');
                const deleteBtnEl = e.target.closest('.delete-btn');

                if (deleteBtnEl) {
                    e.stopPropagation();
                    const questionId = deleteBtnEl.dataset.id;
                    if (confirm(`确定要从错题本中删除题目 ${questionId} 吗？`)) {
                        removeFromErrorBook(questionId);
                    }
                    return;
                }

                if (errorItemEl) {
                    const questionId = errorItemEl.dataset.id;
                    switchMode('error');
                    loadErrorQuestionIntoView(questionId);
                }
            });

            document.addEventListener('keydown', function(e) {
                if (document.getElementById('questionContainer').style.display !== 'flex') return;

                const key = e.key;
                const currentQ = getCurrentQuestion();
                if (!currentQ) return;

                if (['1', '2', '3', '4'].includes(key) && !isSubmitted) {
                    e.preventDefault();
                    const optionIndex = parseInt(key) - 1;
                    const optionKeys = Object.keys(currentQ.options);
                    const targetKey = optionKeys[optionIndex];

                    if (targetKey) {
                        const targetInput = document.querySelector(`#opt-${targetKey}`);
                        if (targetInput) {
                            if (currentQ.type === '单选题') {
                                document.querySelectorAll('.option-item input').forEach(input => {
                                    input.checked = false;
                                    input.closest('.option-item').classList.remove('active');
                                });
                                selectedOptions = [targetKey];
                            } else if (currentQ.type === '多选题') {
                                if (targetInput.checked) {
                                    selectedOptions = selectedOptions.filter(opt => opt !== targetKey);
                                } else {
                                    selectedOptions.push(targetKey);
                                }
                            }

                            targetInput.checked = !targetInput.checked;
                            if (targetInput.checked) {
                                targetInput.closest('.option-item').classList.add('active');
                            } else {
                                targetInput.closest('.option-item').classList.remove('active');
                            }

                            document.getElementById('submitNextBtn').disabled = selectedOptions.length === 0;
                        }
                    }
                }

                if (key === 'Enter') {
                    e.preventDefault();
                    const submitNextBtn = document.getElementById('submitNextBtn');
                    if (!submitNextBtn.disabled) {
                        submitNextBtn.click();
                    }
                }
            });
        }
    </script>
</body>
</html>